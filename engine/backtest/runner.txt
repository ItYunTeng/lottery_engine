from engine.generator import generate_candidates
from engine.fail_patterns import hit_fail_pattern
from engine.scorer import score_v2
from engine.selector import select_top
from engine.backtest.metrics import max_hit, hit_at_least


def backtest(
        history,
        hot_window,
        score_threshold,
        top_n
):
    results = []

    for i in range(30, len(history)):
        past = history[:i]
        real = history[i]
        last = history[i - 1]

        # 热号统计
        freq = {}
        for row in past[-hot_window:]:
            for b in row:
                freq[b] = freq.get(b, 0) + 1
        hot_set = set(sorted(freq, key=freq.get, reverse=True)[:10])

        pre_ds = []
        for balls in generate_candidates(range(1, 34), last, 1):
            if hit_fail_pattern(balls, last):
                continue
            sc = score_v2(balls, last, hot_set, past)
            if sc >= score_threshold:
                pre_ds.append({"balls": balls, "score": sc})

        pre_ds = select_top(pre_ds, top_n)

        results.append({
            "max_hit": max_hit(real, pre_ds),
            "hit3": hit_at_least(real, pre_ds, 3),
            "hit4": hit_at_least(real, pre_ds, 4)
        })

    return results
